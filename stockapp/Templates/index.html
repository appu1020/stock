{% extends 'base.html' %}
{% load static %}

{% block title %}Stock Prediction Dashboard{% endblock %}

{% block content %}
<div class="container mt-4">

    <!-- Display Messages -->
    {% if messages %}
        {% for message in messages %}
            <div class="alert alert-{{ message.tags }} text-center">{{ message }}</div>
        {% endfor %}
    {% endif %}

    <!-- Search Bar -->
    <div class="search-bar mb-4">
        <form method="GET" action="{% url 'dashboard' %}" class="input-group">
            <span class="input-group-text bg-white border-end-0">
                <i class="fas fa-search"></i>
            </span>
            <input type="text" name="symbol" class="form-control border-start-0 p-2" 
                   placeholder="Search for stocks..." value="{{ symbol }}">
            <button type="submit" class="btn btn-primary">Search</button>
        </form>
    </div>

    <!-- Error Handling -->
    {% if error %}
        <div class="alert alert-danger text-center">{{ error }}</div>
    {% else %}

    <!-- Stock Prediction Section -->
    <div class="row">
        <div class="col-md-8">
            <div class="bg-white rounded-lg shadow p-4">
                <h2 class="mb-3">{{ symbol }} Stock Prediction</h2>
                <canvas id="stockChart"></canvas>
            </div>
        </div>

        <!-- Key Metrics -->
        <div class="col-md-4">
            <div class="bg-white rounded-lg shadow p-4">
                <h3>Key Metrics</h3>
                <p><strong>Current Price:</strong> ${{ current_price }}</p>
                <p><strong>Predicted Price:</strong> <span class="text-success">${{ predicted_price }}</span></p>
                <p><strong>Predicted High:</strong> <span class="text-danger">${{ predicted_high }}</span></p>
                <p><strong>Predicted Low:</strong> <span class="text-primary">${{ predicted_low }}</span></p>
                <p><strong>Moving Average (50-day):</strong> {{ moving_avg }}</p>

                <!-- Add to Wishlist Form -->
                <form method="POST" action="{% url 'add_to_wishlist' %}">
                    {% csrf_token %}
                    <input type="hidden" name="symbol" value="{{ symbol }}">
                    <button type="submit" class="btn btn-dark mt-3 w-100">Add to Wishlist</button>
                </form>
            </div>
        </div>
    </div>

    <!-- Volume Analysis -->
    <div class="row mt-4">
        <div class="col-md-12">
            <div class="bg-white rounded-lg shadow p-4">
                <h3>Volume Analysis</h3>
                <canvas id="volumeChart"></canvas>
            </div>
        </div>
    </div>

    {% endif %}
</div>

<!-- Chart.js for interactive charts -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
document.addEventListener("DOMContentLoaded", function () {
    {% if not error %}

    // Stock Chart with Prediction
    var ctxStock = document.getElementById('stockChart').getContext('2d');
    var stockDates = {{ stock_dates|safe }};
    var stockPrices = {{ stock_prices|safe }};
    var predictedDate = stockDates[stockDates.length - 1];  // Use the last date
    var predictedPrice = {{ predicted_price }};

    new Chart(ctxStock, {
        type: 'line',
        data: {
            labels: stockDates.concat([predictedDate]),
            datasets: [{
                label: '{{ symbol }} Stock Price',
                data: stockPrices.concat([predictedPrice]),  // Add predicted value to the graph
                borderColor: '#007bff',
                backgroundColor: 'rgba(0, 123, 255, 0.1)',
                fill: true,
                pointBackgroundColor: ['blue'].concat(['red']), // Highlight prediction in red
                pointRadius: stockPrices.map(() => 3).concat([6]), // Make prediction dot bigger
            }]
        },
        options: {
            responsive: true,
            scales: {
                x: { display: true, title: { display: true, text: 'Date' }},
                y: { display: true, title: { display: true, text: 'Price (USD)' }}
            }
        }
    });

    // Volume Chart
    var ctxVolume = document.getElementById('volumeChart').getContext('2d');
    new Chart(ctxVolume, {
        type: 'bar',
        data: {
            labels: stockDates,
            datasets: [{
                label: 'Stock Volume',
                data: {{ stock_prices|safe }},
                backgroundColor: 'rgba(255, 99, 132, 0.5)'
            }]
        },
        options: {
            responsive: true,
            scales: {
                x: { display: true, title: { display: true, text: 'Date' }},
                y: { display: true, title: { display: true, text: 'Volume' }}
            }
        }
    });

    {% endif %}
});
</script>

{% endblock %}
